<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <script src="/Style/JS/Aries.Loader.js"></script>
</head>
<body>
    <table id="configTable" class="cont-box-tab"></table>
    <div id="ToolBar">
        <div class="function-box">
            <a onclick="onAdd()">
                <input class="add" type="button" name="新增" value="" />
            </a>
            <a onclick="onCancel()">
                <input class="btn-sm" type="button" name="" value="取消" />
            </a>
            <a href="javascript:void(0)" onclick="DelRowsFun()">
                <input class="delete" type="button" name="删除" value="" />
            </a>
            <a>
                <input class="btn-sm" type="button" id="btn_cancel" name="" value="关闭窗口" />
            </a>
            <span><b><a onclick="showSQL();"><font color="red">下载同步脚本</font></a></b></span>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">

    var excelID = AR.Utility.queryString('id');
    var result = AR.Utility.Ajax.post('MappingExcelInfo','',{id:excelID},false);
    var objName=result.objName;
    var arrTables = result.arrTables;
    var arrColumns = result.arrColumns;
    var editIndex;
    var editId;
    var returndata;
    var TableName;
    var editRow = {};
    var mid = function () {
        var topWin = window, mid = parent.AR.Global.Variable.mid;
        if (!mid) {
            mid = (function (win) {
                var ar = win.AR;
                if (ar.Global.Variable.mid || win == win.top) {
                    return ar.Global.Variable.mid;
                }
                return arguments.callee(win.parent.window);
            })(topWin);
        }
        return mid;
    }();
    
    var formatCheckbox = function (value, row, index) {
        if (value == true || value == 1) {
            return "<input type='checkbox' checked='checked' disabled='disabled' />";
        }
        return "<input type='checkbox' disabled='disabled' />";
    }
    var editorCheckbox = {
        type: 'checkbox',
        options: {
            on: 1,
            off: 0
        }
    }
    var editorRequiredTextBox = {
        type: 'validatebox',
        options: {
            required: true,
            validType: 'length[0,50]'
        }
    }
    var editorTextBox = {
        type: 'validatebox',
        options: {
            validType: 'length[0,50]'
        }
    }
    var tables;
    $(function () {

        myConfigDataGrid = $('#configTable');
        //AR.registEvent("cancel");
        //AR.Utility.Ajax.Settings.url=AR.route.excel;
        AR.Utility.Ajax.Settings.objName = "Config_ExcelInfo";
        KeyUpDownFun();
        // GetTables();
        myConfigDataGrid.datagrid({
            toolbar: "#ToolBar",
            striped: true,
            nowwrap: false,
            height: $(document).height(),
            border: true,
            //fit: true,
            fitColumns: false,
            loadMsg: "正在使劲加载中...",
            idField: 'ID',
            sortName: "CreateTime",
            remoteSort: false,
            //onBeforeEdit:onBeforeEdit,
            onBeforeLoad:function(param){
                param.sys_mid = mid;
            },
            queryParams: {
                sys_search: JSON.stringify([{ paramName: 'ExcelID', paramValue: excelID, paramPatten: 'Equal' }])
            },
            url: AR.route.root + '?sys_method=GetList&sys_objName=Config_ExcelInfo&ExcelID='+excelID,
            collapsible: true,
            pagination: false,//分页
            rownumbers: true,
            singleSelect: true,
            onClickRow: onClickRow,
            columns: [[
            { field: 'ExceInfoID', title: 'ExceInfoID', sortable: true, align: 'center', width: "250" },//,formatter:formatLink, checkbox: true
            //{ field: 'TableName', title: '数据表名', align: 'center', width: "180" },
            {
                field: 'ExcelName', title: 'Excel列名', sortable: true, align: 'center', width: "250",
                editor: editorRequiredTextBox
            },
            {
                field: 'TableName', title: '表名', sortable: true, align: 'center', width: "200",
                editor: {
                    type: 'combobox',
                    options: {
                        valueField: 'Value',
                        textField: 'Key',
                        data: arrTables,
                        onSelect:setArrColumns
                    }
                }
            }, {
                field: 'Field', title: '字段名', sortable: true, align: 'center', width: "150", editor: {
                    type: 'combobox',
                    options: {
                        valueField: 'Value',
                        textField: 'Key'
                        //, data: arrColumns
                        // ,onSelect: setArrColumns
                    }
                }
            },
            {
                field: 'IsRequired', title: '必填', sortable: true, align: 'center', width: "50", formatter: formatCheckbox,
                editor: editorCheckbox
            }
            ,
            {
                field: 'IsUnique', title: '唯一', sortable: true, align: 'center', width: "50", formatter: formatCheckbox,
                editor: editorCheckbox
            }
            ,
            {
                field: 'IsForeignkey', title: '外键', sortable: true, align: 'center', width: "50", formatter: formatCheckbox,
                editor: editorCheckbox
            },
            {
                field: 'ForeignTable', title: '外键表名', sortable: true, align: 'center', width: "200",
                editor: {
                    type: 'combobox',
                    options: {
                        valueField: 'Value',
                        textField: 'Key',
                        data: arrTables,
                    }
                }
            },
            //{
            //    field: 'DataType', title: '数据类型', sortable: true, align: 'center', width: "150", editor: editorRequiredTextBox
            //},
            //{
            //    field: 'Scale', title: '小数位数', sortable: true, align: 'center', width: "150", editor: editorRequiredTextBox
            //},
            //{
            //    field: 'Size', title: '长度', sortable: true, align: 'center', width: "150", editor: editorRequiredTextBox

            //},
            {
                field: 'Formatter', title: '格式化', sortable: true, align: 'center', width: "150", editor: editorTextBox

            }
            //,
            //{
            //    field: 'ValidateFunction', title: '校验方法', sortable: true, align: 'center', width: "150",editor: editorTextBox

            //}//,
            ,{
                field: 'CreateTime', title: '创建时间', sortable: true, align: 'center', width: "150", editor: {
                    type: 'datebox'

                }
            }
            ]]

        });


    });
    var editing = false;//正在编辑状态
    var isButtonClick = false;
    //单击时
    function onClickRow(rowIndex, rowData) {
        if (editing)//结束状态，结束编辑
        {
            endEditing();
        }
        if (!isButtonClick && !editing && this.editIndex != rowIndex) //新点一行。
        {
            AR.Utility.Ajax.Settings.method = "Update";
            beginEdit(rowIndex, rowData);

        }
        isButtonClick = false;
    }

    function setColCombobox(tname,defaultValue)
    {
        var json=arrColumns[tname];
        var comb = myConfigDataGrid.datagrid('getEditor', { index: editIndex, field: 'Field' });
        $(comb.target).combobox({
            data: json
        });
        if(defaultValue)
        {
            $(comb.target).combobox("select",defaultValue);
        }

    }

    function setArrColumns(record)
    {
        var tname = record.Key;
        setColCombobox(tname);


    }
    function formatLink(value, row, index)
    {
        if (isNaN(value))
        {
            return  '<input type="button" onclick="saveAdd();" value="保存" />';
        }
        return value;
    }
    function beginEdit(editIndex, rowData) {
        this.editIndex = editIndex;
        this.editing = true;
        this.editRow = $.extend(true, {}, rowData);
        myConfigDataGrid.datagrid('beginEdit', editIndex);
        setColCombobox(rowData.TableName,rowData.Field);
    }
    //结束编辑
    function endEditing() {
        if (myConfigDataGrid.datagrid('validateRow', editIndex)) {
            var s = AR.Utility.Ajax.Settings.method == "Update" ? 'updated' : '';            
            myConfigDataGrid.datagrid('endEdit', editIndex);
            var updated = myConfigDataGrid.datagrid('getChanges', s);//,
            if (updated.length > 0) {
                if (AR.Utility.Ajax.Settings.method == "Update") {
                    var changeJson = getChangeJson(updated[0], editRow);
                    if (changeJson.ExceInfoID != undefined) {
                        Exec(changeJson);
                    }
                    else {
                        myConfigDataGrid.datagrid("rejectChanges");
                    }
                }
                else if (AR.Utility.Ajax.Settings.method == "Add") {
                    updated[0].ID = "";
                    Exec(updated[0]);
                    if (updated[0].ID) {
                        myConfigDataGrid.datagrid("rejectChanges");//还原保存按钮为显示ID
                    }
                    isButtonClick = true;
                }
            }

        }
        else {
            myConfigDataGrid.datagrid('endEdit', editIndex);
            myConfigDataGrid.datagrid("rejectChanges");
        }
        editIndex = undefined;
        this.editing = false;

    }
    //用于检测值是否被修改了，如果修改了，只提取出修改过的值。
    function getChangeJson(newJson, oldJson) {
        var changeJson = {};
        var count = 0;
        if (oldJson && oldJson.ExceInfoID == newJson.ExceInfoID) {
            for (var item in newJson) {
                if ((oldJson[item] == undefined && newJson[item].toString() != "") ||
                    oldJson[item] != undefined && oldJson[item].toString() != newJson[item].toString()) {
                    changeJson[item] = newJson[item];
                    count++;
                }
            }
        }
        if (count > 0) {
            changeJson.ExceInfoID = newJson["ExceInfoID"];
            //changeJson.LastEditTime = "now()";
        }
        return changeJson;
    }
    //obj对象转数组
    function JsonObj2Arr(json, formData) {
        for (var key in json) {
            formData.push({ name: key, value: json[key] });
        }
    }
    //function GetTables() {



    //    $.ajax({
    //        type: "POST",
    //        async: false,
    //        url: AR.Utility.Ajax.Settings.url+'?method=GetTable&mid='+mid,
    //        //data: AR.Utility.Ajax.Settings.data,
    //        dataType: "json",
    //        success: function (data) { tables = data;}
    //    });
    //}
    //ajax操作
    function Exec(json) {

        var formData = [];
        JsonObj2Arr(json, formData);
        formData.push({ name: "sys_method", value: AR.Utility.Ajax.Settings.method });
        formData.push({ name: "sys_objName", value: AR.Utility.Ajax.Settings.objName });
        formData.push({ name: "sys_mid", value: mid });
        AR.Utility.Ajax.Settings.data = formData;
        AR.Utility.Ajax.Settings.async = false;
        $.ajax({
            type: "POST",
            async: AR.Utility.Ajax.Settings.async,
            url: AR.Utility.Ajax.Settings.url,
            data: AR.Utility.Ajax.Settings.data,
            dataType: AR.Utility.Ajax.Settings.dataType,
            success: function (data) {
                var tip = "";
                switch (AR.Utility.Ajax.Settings.method) {
                    case "Add":
                        tip = "添加"; break;
                    case "Update":
                        tip = "更新"; break;
                    case "Delete":
                        myConfigDataGrid.datagrid('deleteRow', editIndex);
                        tip = "删除"; break;
                }
                if (data.success) {
                    if (AR.Utility.Ajax.Settings.method == "Add") {
                        json.ID = data.msg;
                    }
                    AR.Utility.Window.refresh = true; //关闭刷新父窗体
                    myConfigDataGrid.datagrid("acceptChanges");
                    AR.Utility.Window.showMsg(tip + "成功！");
                }
                else {
                    myConfigDataGrid.datagrid("rejectChanges");
                    AR.Utility.Window.showMsg(tip + "失败：" + data.msg);
                }
            },
            error: function (d) {
                console.log("服务器出错");
            }
        });
    }
    function saveAdd() {
        AR.Utility.Ajax.Settings.method = "Add";
    }
    //新增
    function onAdd() {
        onCancel();
        var row = {
            'ID': '<input type="button" onclick="saveAdd();" value="保存" />',
            "ExcelID": excelID
        }
        myConfigDataGrid.datagrid('appendRow', row);
        var rows = myConfigDataGrid.datagrid('getRows');
        editIndex = rows.length - 1;
        beginEdit(editIndex, row);
    }

    function onCancel() {
        if (editing)//结束状态，结束编辑
        {
            this.editRow = null;
            endEditing();
        }
        if (AR.Utility.Ajax.Settings.method == "Add" && editIndex != undefined) {
            myConfigDataGrid.datagrid('deleteRow', editIndex);
            editIndex = undefined
        }
    }

    function DelRowsFun() {
        if (editIndex == undefined) {
            alert("请先选择要删除的数据行");
            return;
        }
        if (confirm('是否删除ID为' + editRow.ID + "的数据行?")) {
            AR.Utility.Ajax.Settings.method = "Delete";
            var json = {};
            json.ID = editRow.ID;
            Exec(json);
        }

    }

    //鼠标up和dowm事件
    function KeyUpDownFun() {
        //listen keyboad click function
        document.onkeydown = function (e) {

            //IE,firefox 兼容
            var ev = document.all ? window.event : e;
            var obj = ev.srcElement ? ev.srcElement : ev.target;
            var tdField;
            if (obj.className != "panel-noscroll" && obj.parentNode.parentNode) {
                tdField = $(obj.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode).attr("field");//
            }
            // Up
            if (ev.keyCode == 38) {
                if (editIndex == undefined) {
                    return true;
                }

                var allrows = myConfigDataGrid.datagrid("getRows");
                var nextIndex = editIndex - 1;
                if (nextIndex > -1) {
                    onClickRow(nextIndex, allrows[nextIndex]);
                    if (tdField) {
                        var editor = myConfigDataGrid.datagrid('getEditor', { index: nextIndex, field: tdField });
                        $(editor.target[0]).focus();
                    }
                }
            }
                //Down
            else if (ev.keyCode == 40) {
                if (editIndex == undefined) {
                    return true;
                }

                var allrows = myConfigDataGrid.datagrid("getRows");
                var nextIndex = editIndex + 1;
                if (allrows.length > nextIndex) {
                    onClickRow(nextIndex, allrows[nextIndex]);

                    if (tdField) {
                        var editor = myConfigDataGrid.datagrid('getEditor', { index: nextIndex, field: tdField });
                        $(editor.target[0]).focus();
                    }
                }
            }
        }
    }

</script>

<script>
    function showSQL()
    {
        AR.Utility.download('GetExcelConfigScript', { "ID": excelID,sys_objName:objName });
    }
</script>